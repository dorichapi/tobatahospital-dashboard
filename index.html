<script>
    async function fetchData() {
        try {
            const apiUrl = "https://script.google.com/macros/s/AKfycbzKpOJbCEKwdK6oDn9W5LbSxNhdlN-XDYJvLguT0UOIzDRVE1gtB3LHt8MZ_eLTh5I0/exec";
            const response = await fetch(apiUrl);
            const result = await response.json();

            console.log("Fetched Data:", result);

            if (!result.data || !Array.isArray(result.data) || result.data.length === 0) {
                console.warn("⚠ データがありません。");
                return;
            }

            const data = result.data.map(row => ({
                ...row,
                日付: new Date(row["日付"]),
                "病床利用率 (%)": (row["病床利用率 (%)"] * 100).toFixed(1) // ✅ 100倍して `98.2%` の形式に変換
            }));

            const latestData = data[data.length - 1];

            // **最終入力時間を日本時間に変換**
            const lastEditTime = new Date(result.lastEditTime);
            lastEditTime.setHours(lastEditTime.getHours() + 9); // UTC → JST
            const formattedTime = `${lastEditTime.getHours()}時${String(lastEditTime.getMinutes()).padStart(2, '0')}分`;

            document.getElementById("latest-date").innerText = `日付: ${formatDate(latestData["日付"])} ${formattedTime}`;
            document.getElementById("bed-usage").querySelector(".value").innerText = `${latestData["病床利用率 (%)"]}%`;
            document.getElementById("ambulance").querySelector(".value").innerText = latestData["救急車搬入数"] + "人";
            document.getElementById("inpatients").querySelector(".value").innerText = latestData["入院患者数"] + "人";
            document.getElementById("discharges").querySelector(".value").innerText = latestData["退院予定数"] + "人";

            const labels = formatChartLabels(data.map(row => row["日付"]));

            createChart("bedChart", "病床利用率", labels, data.map(row => row["病床利用率 (%)"]), "blue", "％");
            createChart("ambulanceChart", "救急車搬入数", labels, data.map(row => row["救急車搬入数"]), "red", "人");
            createChart("inpatientsChart", "入院患者数", labels, data.map(row => row["入院患者数"]), "green", "人");
            createChart("dischargesChart", "退院予定数", labels, data.map(row => row["退院予定数"]), "orange", "人");
        } catch (error) {
            console.error("❌ エラー発生:", error);
        }
    }

    function formatChartLabels(dates) {
        return dates.map((date, index) => {
            const d = new Date(date);
            return index === 0 ? `${d.getMonth() + 1}月${d.getDate()}日` : `${d.getDate()}`;
        });
    }

    function formatDate(dateObj) {
        return `${dateObj.getMonth() + 1}月${dateObj.getDate()}日`;
    }

    fetchData();
</script>
